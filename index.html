<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Brain Extension</title>
    <style>
        :root { --primary-color: #4A90E2; --bg-color: #f5f7fa; --card-bg: #ffffff; --text-color: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        header { background: var(--primary-color); color: white; padding: 1rem; text-align: center; font-weight: bold; }
        .tab-bar { position: sticky; top: 0; width: 100%; background: white; display: flex; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-item { padding: 15px 0; flex: 1; text-align: center; color: #888; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-item.active { color: var(--primary-color); font-weight: bold; border-bottom: 3px solid var(--primary-color); }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .card:active { transform: scale(0.98); }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .task-row:last-child { border-bottom: none; }
        .task-completed { color: #aaa; text-decoration: line-through; }
        .task-text-done { color: #aaa; }
        
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        .progress-container { background: #eee; border-radius: 10px; height: 6px; margin: 8px 0; overflow: hidden; }
        .progress-bar { background: var(--primary-color); height: 100%; transition: width 0.3s; }

        #form-overlay, #detail-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .form-container { background: white; width: 90%; max-width: 500px; border-radius: 15px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1500; cursor: pointer; }
        
        button { background: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; border: none !important; }
        .page { display: none; }
        .page.active { display: block; }
        input[type="text"], textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        label { font-size: 0.85rem; font-weight: bold; color: #666; display: block; margin-top: 10px; }

        @keyframes flash { 0% { background: #fff; } 50% { background: #e3f2fd; } 100% { background: #fff; } }
        .highlight { animation: flash 1.5s ease-in-out; border-color: var(--primary-color) !important; }

        .task-text-done {
            opacity: 0.6;
            background-color: #f9f9f9 !important;
        }
        .task-text-done div, .task-text-done span {
            color: #888 !important;
        }
    </style>
</head>
<body>

<header>My Brain Extension</header>
<nav class="tab-bar">
    <div id="tab-goals" class="tab-item active" onclick="showPage('goals')">ç›®æ¨™</div>
    <div id="tab-tasks" class="tab-item" onclick="showPage('tasks')">ã‚¿ã‚¹ã‚¯</div>
    <div id="tab-logs" class="tab-item" onclick="showPage('logs')">è¨˜éŒ²</div>
</nav>

<div class="container">
    <div id="page-goals" class="page active"><h2>ç›®æ¨™ä¸€è¦§</h2><div id="list-goals"></div></div>
    <div id="page-tasks" class="page">
        <h2>ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
        <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select id="task-sort-mode" onchange="renderTasks()" style="flex:1; margin:0; padding:8px; font-size:0.8rem;">
                <option value="date">æœŸé™é † (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                <option value="priority">å„ªå…ˆåº¦é †</option>
                <option value="goal">ç›®æ¨™åˆ¥</option>
                <option value="parent">è¦ªã‚¿ã‚¹ã‚¯åˆ¥</option>
            </select>
            <input type="text" id="task-search" placeholder="æ¤œç´¢..." oninput="renderTasks()" style="flex:1; margin:0; padding:8px; font-size:0.8rem;">
            
            <label style="display:flex; align-items:center; gap:5px; font-size:0.75rem; margin:0; cursor:pointer; white-space:nowrap;">
                <input type="checkbox" id="task-filter-incomplete" onchange="renderTasks()" style="width:16px; height:16px; margin:0;">
                æœªå®Œäº†ã®ã¿
            </label>
        </div>
    <div id="list-tasks"></div>
</div>
    <div id="page-logs" class="page">
        <h2>è¨˜éŒ²ä¸€è¦§</h2>
        
        <div class="log-tabs" style="display:flex; background:#eee; border-radius:10px; padding:4px; margin-bottom:15px;">
            <div class="log-tab-item active" onclick="switchLogTab('ã™ã¹ã¦', this)" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.85rem;">ã™ã¹ã¦</div>
            <div class="log-tab-item" onclick="switchLogTab('æ€è€ƒã®å£æ‰“ã¡', this)" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.85rem;">æ€è€ƒ</div>
            <div class="log-tab-item" onclick="switchLogTab('è‹±èªæ—¥è¨˜', this)" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.85rem;">è‹±èª</div>
            <div class="log-tab-item" onclick="switchLogTab('èª­æ›¸è¨˜éŒ²', this)" style="flex:1; text-align:center; padding:8px; cursor:pointer; border-radius:8px; font-size:0.85rem;">èª­æ›¸</div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 15px; width: 100%;">
            <input type="text" id="search-input" oninput="renderLogs(this.value)" placeholder="è¨˜éŒ²ã‚’æ¤œç´¢..." 
                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; outline: none;">
            
            <button id="root-filter-btn" onclick="toggleRootFilter()" 
                    style="width: 70px; height: 40px; padding: 0; background: #f0f2f5; border: 1px solid #ddd; border-radius: 8px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2;">
                <span id="root-filter-icon" style="font-size: 1rem;">ğŸ”˜</span>
                <span style="font-size: 0.6rem;">è¦ªã®ã¿</span>
            </button>
        </div>

        <div id="list-logs"></div>
    </div>
</div>

<div class="fab" onclick="openForm()">ï¼‹</div>

<div id="detail-overlay" onclick="this.style.display='none'">
    <div class="form-container" onclick="event.stopPropagation()">
        <h2 id="detail-title"></h2>
        <div id="detail-dynamic-body"></div> 
    </div>
</div>

<div id="form-overlay" onclick="this.style.display='none'">
    <div class="form-container" onclick="event.stopPropagation()">
        <h2 id="form-title">æ–°è¦ä½œæˆ</h2>
        <div id="form-content"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="background:#666;" onclick="document.getElementById('form-overlay').style.display='none'">ä¸­æ­¢</button>
            <button onclick="submitForm()">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzGcijJMjdK0ewoXL1Mlvytkypf5-jFvT25i_ZozvxoRkRGmVmYxwSskfziSjlFl0Oc/exec";
    let db = { Goals: [], Tasks: [], Logs: [] };
    let currentPage = 'goals';

    window.onload = refreshData;

    async function refreshData() {
        // 3å›å‘¼ã‚“ã§ã„ãŸã®ã‚’1å›ã«ã¾ã¨ã‚ã‚‹
        const res = await fetch(`${GAS_URL}?action=fetchAll`);
        const allData = await res.json();
        db.Goals = allData.Goals;
        db.Tasks = allData.Tasks;
        db.Logs = allData.Logs;
        
        renderGoals(); renderTasks(); renderLogs();
    }

    // ã©ã“ã‹ã‚‰ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«é–¢æ•°ã®å¤–ã«ç½®ã
    function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr; 
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    async function fetchData(sheetName) {
        try {
            const res = await fetch(`${GAS_URL}?sheetName=${sheetName}`);
            const data = await res.json();
            db[sheetName === 'Daily_Logs' ? 'Logs' : sheetName] = data;
        } catch(e) { console.error("Fetch error:", e); }
    }

    function calculateProgress(tasks) {
        if (tasks.length === 0) return 0;
        const completed = tasks.filter(t => t[5] === 'å®Œäº†').length;
        return Math.round((completed / tasks.length) * 100);
    }

    function showPage(p) {
        currentPage = p;
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.getElementById('tab-' + p).classList.add('active');

        // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã«æœ€æ–°ã®çŠ¶æ…‹ã§å†æç”»ã™ã‚‹
        if (p === 'goals') renderGoals();
        else if (p === 'tasks') renderTasks();
        else if (p === 'logs') renderLogs();
    }

    function renderGoals() {
        const container = document.getElementById('list-goals');
        container.innerHTML = "";
        const now = new Date();
        const currentYear = String(now.getFullYear());
        const currentMonthNum = String(now.getMonth() + 1).padStart(2, '0');
        const currentYearMonth = `${currentYear}-${currentMonthNum}`;

        const goals = db.Goals.slice(1);
        const cleanDate = (val) => String(val).replace(/'/g, "");

        // æŠ½å‡ºï¼šä»Šå¹´ã€ä»Šæœˆã€ä»Šé€±ã€ãã®ä»–
        const yearGoals = goals.filter(g => cleanDate(g[5]) === currentYear && g[1] === "å¹´é–“");
        const monthGoals = goals.filter(g => cleanDate(g[5]) === currentYearMonth && g[1] === "æœˆé–“");
        const weeklyGoals = goals.filter(g => cleanDate(g[5]).startsWith(currentYearMonth) && g[1] === "é€±é–“");
        const otherGoals = goals.filter(g => {
            const d = cleanDate(g[5]);
            return !((d === currentYear && g[1] === "å¹´é–“") || (d === currentYearMonth && g[1] === "æœˆé–“") || (d.startsWith(currentYearMonth) && g[1] === "é€±é–“"));
        });

        const statusSort = (a, b) => (a[4] === 'å®Œäº†' ? 1 : 0) - (b[4] === 'å®Œäº†' ? 1 : 0);

        const renderCard = (g) => {
            const relatedTasks = db.Tasks.filter(t => t[2] === g[0]);
            const progress = calculateProgress(relatedTasks);
            const isDone = g[4] === 'å®Œäº†';
            
            const card = document.createElement('div');
            // ã€é‡è¦ã€‘å®Œäº†ãªã‚‰å³åº§ã« done ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
            card.className = `card ${isDone ? 'task-text-done' : ''}`;
            card.id = 'goal-card-' + g[0];
            card.style.display = "flex";
            card.style.flexDirection = "column";

            card.onclick = (e) => {
                if (e.target.tagName !== 'BUTTON') showGoalDetail(g, relatedTasks);
            };

            let progressHtml = relatedTasks.length > 0 ? `
                <div class="progress-container" style="margin-top:10px;"><div class="progress-bar" style="width:${progress}%"></div></div>
                <div style="font-size:0.7rem; text-align:right; color:#888;">é€²æ—: ${progress}%</div>` : "";

            card.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-size:0.75rem; color:#555; font-weight:bold;">
                        <span style="color:var(--primary-color);">[${g[1]}]</span> ${cleanDate(g[5])}
                    </div>
                    <div style="font-weight:bold; font-size:1.05rem; margin-top:4px; color:#333;">${g[2]}</div>
                    ${progressHtml}
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="event.stopPropagation(); updateGoalStatus('${g[0]}', '${isDone ? 'é€²è¡Œä¸­' : 'å®Œäº†'}')" 
                            style="font-size:0.7rem; padding:6px 16px; border-radius:15px; border:none;
                                background:${isDone ? '#ccc' : 'var(--primary-color)'}; 
                                color:white; 
                                cursor:pointer; font-weight:bold; transition: 0.2s;">
                        ${isDone ? 'å†é–‹' : 'å®Œäº†'}
                    </button>
                </div>`;
            return card;
        };

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«æç”»
        if(yearGoals.length > 0) {
            container.insertAdjacentHTML('beforeend', `<h3 class="section-title">ğŸŒŸ å¹´é–“ç›®æ¨™</h3>`);
            yearGoals.sort(statusSort).forEach(g => container.appendChild(renderCard(g)));
        }
        if(monthGoals.length > 0) {
            container.insertAdjacentHTML('beforeend', `<h3 class="section-title">ğŸ“… ä»Šæœˆã®ç›®æ¨™</h3>`);
            monthGoals.sort(statusSort).forEach(g => container.appendChild(renderCard(g)));
        }
        if(weeklyGoals.length > 0) {
            container.insertAdjacentHTML('beforeend', `<h3 class="section-title">ğŸƒ ä»Šé€±ã®ç›®æ¨™</h3>`);
            weeklyGoals.sort(statusSort).forEach(g => container.appendChild(renderCard(g)));
        }
        if(otherGoals.length > 0) {
            const det = document.createElement('details');
            det.style.marginTop = "30px";
            det.innerHTML = `<summary style="color:#888; cursor:pointer; font-weight:bold; padding:10px; text-align:center; list-style:none;">â–¼ éå»ãƒ»ãã®ä»–ã®ç›®æ¨™ã‚’è¡¨ç¤º</summary>`;
            otherGoals.sort(statusSort).forEach(g => det.appendChild(renderCard(g)));
            container.appendChild(det);
        }

        const reviewSection = document.createElement('div');
        reviewSection.style.cssText = "margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; padding-bottom: 50px;";
        reviewSection.innerHTML = `
            <button onclick="openReviewModal()" style="width:100%; padding:15px; background:var(--primary-color); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                ä»Šæœˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹
            </button>
            
            <details style="margin-top: 15px; background: white; border-radius: 8px; padding: 10px; border: 1px solid #eee;">
                <summary style="font-weight: bold; cursor: pointer; color: var(--primary-color); outline: none;">éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹</summary>
                <div id="review-links-list" style="margin-top: 10px; font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px;">
                    </div>
            </details>
        `;
        container.appendChild(reviewSection);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆåˆæœŸåŒ–ï¼‰
    function openReviewModal() {
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('review-modal').style.display = 'flex';
        
        const picker = document.getElementById('review-month-picker');
        picker.value = currentMonth; // ä»Šæœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ã™ã‚‹
        updateReviewContent(currentMonth); // æœ€åˆã®ä¸€å›ã‚’å®Ÿè¡Œ
    }

    // é¸æŠã•ã‚ŒãŸæœˆã‚’å…ƒã«ä¸­èº«ã‚’æç”»ã™ã‚‹ï¼ˆè‚ã®éƒ¨åˆ†ï¼ï¼‰
    function updateReviewContent(selectedMonth) {
        const modalBody = document.getElementById('review-modal-body');
        if (!modalBody) return;

        // 1. ãã®æœˆã®ç›®æ¨™ã‚’æŠ½å‡º
        const monthGoals = db.Goals.slice(1).filter(g => g[5] && String(g[5]).includes(selectedMonth));

        if (monthGoals.length === 0) {
            modalBody.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">' + selectedMonth + ' ã®ç›®æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        const allTasks = db.Tasks.slice(1);
        let html = '<h4 style="font-size:0.9rem; margin-bottom:15px; color:#666; border-bottom:1px solid #eee; padding-bottom:5px;">ç›®æ¨™ã®é”æˆç‡ã‚’è¨­å®š</h4>';

        monthGoals.forEach((g, idx) => {
            const goalId = String(g[0]).trim();
            // ç´ã¥ã‘æˆåŠŸã—ãŸ t[2] (Goal_IDåˆ—) ã‚’ä½¿ç”¨
            const relatedTasks = allTasks.filter(t => String(t[2] || "").trim() === goalId);
            const doneCount = relatedTasks.filter(t => String(t[5]).trim() === 'å®Œäº†').length;
            const autoRate = relatedTasks.length > 0 ? Math.round((doneCount / relatedTasks.length) * 100) : 0;
            const typeLabel = g[1] ? '[' + g[1] + '] ' : "";

            html += '<div style="margin-bottom:15px; padding:15px; background:#fcfcfc; border:1px solid #efefef; border-radius:10px; border-left:5px solid ' + (g[1] === 'æœˆé–“' ? '#1a73e8' : '#34a853') + ';">';
            html += '<div style="font-weight:bold; font-size:0.95rem; margin-bottom:8px; white-space:pre-wrap; word-break:break-all;">' + typeLabel + g[2] + '</div>';
            html += '<div style="display:flex; align-items:center; gap:12px;">';
            html += '<input type="range" class="goal-rate-slider" data-title="' + typeLabel + g[2] + '" data-reason="' + (g[3] || '') + '" value="' + autoRate + '" min="0" max="100" style="flex:1;" oninput="this.nextElementSibling.innerText = this.value + \'%\'">';
            html += '<span style="font-weight:bold; color:var(--primary-color); width:45px; text-align:right;">' + autoRate + '%</span>';
            html += '</div>';
            html += '<div style="font-size:0.75rem; color:#999; margin-top:8px;">é€²æ—: ' + doneCount + ' / ' + relatedTasks.length + ' å®Œäº†</div>';
            html += '</div>';
        });

        // 2. æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®æŠ½å‡ºï¼ˆæœŸé™ï¼št[6] Gåˆ—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼št[5] Fåˆ— ã‚’ä½¿ç”¨ï¼‰
        const incompleteTasks = allTasks.filter(t => {
            if (!t[6]) return false; // æœŸé™ãŒãªã„ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
            const d = new Date(t[6]);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const taskMonth = y + '-' + m;
            
            return taskMonth === selectedMonth && String(t[5]).trim() === 'æœªå®Œäº†';
        });

        if (incompleteTasks.length > 0) {
            html += '<h4 style="margin-top:25px; color:#ff4d4f; font-size:0.9rem; border-bottom:1px solid #fee; padding-bottom:5px;">æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®æŒã¡è¶Šã—ç¢ºèª</h4>';
            html += '<p style="font-size:0.7rem; color:#888; margin-bottom:10px;">æœŸé™ãŒä»Šæœˆã§æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚ç¿Œæœˆã¸é€ã‚Šã¾ã™ã‹ï¼Ÿ</p>';
            incompleteTasks.forEach((t) => {
                html += '<div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #f9f9f9;">';
                html += '<span style="font-size:0.8rem; flex:1; padding-right:15px; white-space:pre-wrap; word-break:break-all;">' + t[3] + '</span>';
                html += '<div style="display:flex; gap:10px; white-space:nowrap;">';
                html += '<label style="font-size:0.8rem; cursor:pointer;"><input type="radio" name="carry-' + t[0] + '" value="yes" checked> é€ã‚‹</label>';
                html += '<label style="font-size:0.8rem; cursor:pointer;"><input type="radio" name="carry-' + t[0] + '" value="no"> æ¶ˆã™</label>';
                html += '</div></div>';
            });
        } else {
            html += '<p style="font-size:0.8rem; color:#666; margin-top:20px;">âœ… ä»Šæœˆã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        modalBody.innerHTML = html;
    }

    // ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡éƒ¨åˆ†ã‚‚é¸æŠã•ã‚ŒãŸæœˆã«åˆã‚ã›ã‚‹
    async function submitReview() {
        const selectedMonth = document.getElementById('review-month-picker').value;
        if (!selectedMonth) return alert("æœˆã‚’é¸æŠã—ã¦ãã ã•ã„");
        
        if (!confirm(`${selectedMonth} åˆ†ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã€ã‚¿ã‚¹ã‚¯ã‚’æ•´ç†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

        const btn = document.getElementById('submit-review-btn');
        btn.disabled = true;
        btn.innerText = "é€ä¿¡ä¸­...";

        try {
            const goalData = [];
            document.querySelectorAll('.goal-rate-slider').forEach(slider => {
                goalData.push({
                    title: slider.getAttribute('data-title'),
                    reason: slider.getAttribute('data-reason'),
                    rate: slider.value
                });
            });

            const carryForwardTasks = [];
            const allTasks = db.Tasks.slice(1);
            
            // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®æŒã¡è¶Šã—åˆ¤å®š
            allTasks.forEach(t => {
                const radio = document.querySelector(`input[name="carry-${t[0]}"]:checked`);
                if (radio && radio.value === 'yes') {
                    carryForwardTasks.push({ id: t[0], parentId: t[1], category: t[2], name: t[3] });
                }
            });

            // GASã¸ã®é€ä¿¡ï¼ˆno-corsãƒ¢ãƒ¼ãƒ‰ï¼‰
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "createMonthlyReview",
                    month: selectedMonth,
                    goals: goalData,
                    carryForwardTasks: carryForwardTasks,
                    deleteTargetMonth: selectedMonth + "-01"
                })
            });

            // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘resultã®åˆ¤å®šã‚’æ¶ˆã—ã€é€ä¿¡å®Œäº†ï¼æˆåŠŸã¨ã—ã¦æ‰±ã†
            alert("é€ä¿¡ã‚’å®Œäº†ã—ã¾ã—ãŸï¼\næ•°ç§’å¾Œã«Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚");
            location.reload(); 

        } catch (e) {
            console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", e);
            alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            btn.disabled = false;
            btn.innerText = "ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ»å‰Šé™¤";
        }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ç”¨ã®é–¢æ•°ã‚‚å¿˜ã‚Œãšã«è¿½åŠ ã—ã¦ãã ã•ã„
    async function updateGoalStatus(id, newStatus) {
        const card = document.getElementById('goal-card-' + id);
        if (card) card.style.opacity = "0.5";

        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "updateStatus", sheetName: "Goals", id: id, status: newStatus })
            });
            const g = db.Goals.find(x => x[0] === id);
            if (g) g[4] = newStatus;
            renderGoals();
        } catch (e) {
            console.error(e);
            refreshData();
        }
    }

    function showGoalDetail(g, tasks) {
        const overlay = document.getElementById('detail-overlay');
        const titleEl = document.getElementById('detail-title');
        const bodyEl = document.getElementById('detail-dynamic-body');

        overlay.style.display = 'flex';
        titleEl.innerText = g[2]; // ç›®æ¨™ã®ã‚¿ã‚¤ãƒˆãƒ«
        titleEl.style.whiteSpace = "pre-wrap";   // æ”¹è¡Œã‚’ç¶­æŒ
        titleEl.style.wordBreak = "break-all";    // æ ã®ç«¯ã§å¼·åˆ¶æ”¹è¡Œ
        titleEl.style.lineHeight = "1.4";         // è¡Œé–“ã‚’å°‘ã—åºƒã’ã¦èª­ã¿ã‚„ã™ã

        // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®HTMLçµ„ã¿ç«‹ã¦
        const taskListHtml = tasks.map(t => {
            const isDone = t[5] === 'å®Œäº†';
            return `
                <div class="task-row" style="display:flex; align-items:center; padding:12px 5px; border-bottom:1px solid #eee; cursor:pointer;" onclick="jumpToTask('${t[0]}')">
                    <span style="font-size:1.2rem; margin-right:12px; color:${isDone ? 'var(--primary-color)' : '#ccc'}">${isDone ? 'â˜‘' : 'â˜'}</span>
                    <span style="${isDone ? 'text-decoration:line-through; color:#999;' : 'color:#333;'} font-size:0.95rem;">${t[3]}</span>
                </div>
            `;
        }).join('');

        // ä¸­èº«ã®ã‚»ãƒƒãƒˆï¼šãƒœã‚¿ãƒ³ã‚’ä¸€ç•ªä¸‹ã«é…ç½®
        bodyEl.innerHTML = `
            <div style="font-size:0.9rem; color:#555; padding:15px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0; margin-bottom:20px; line-height:1.5;">
                <strong style="color:var(--primary-color); display:block; margin-bottom:5px; font-size:0.75rem; text-transform:uppercase;">ç†ç”±</strong>
                <div style="font-size:0.85rem; color:#666; white-space:pre-wrap; word-break:break-all;">${g[3]}</div>
            </div>

            <h4 style="margin:20px 0 10px; color:var(--primary-color); border-bottom: 2px solid #e3f2fd; display:inline-block; padding-bottom:3px; font-size:0.9rem;">
                ç´ã¥ãã‚¿ã‚¹ã‚¯ä¸€è¦§
            </h4>
            <div id="goal-tasks-list" style="margin-bottom:30px;">
                ${taskListHtml || "<p style='font-size:0.9rem; color:#999; padding:20px 0; text-align:center;'>ç´ã¥ãã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>"}
            </div>

            <div style="border-top: 1px solid #eee; pt:20px;">
                <button onclick="deleteItem(event, 'Goals', '${g[0]}'); document.getElementById('detail-overlay').style.display='none';" 
                        style="width:100%; padding:12px; background:#fff; border:1px solid #ff4d4f; color:#ff4d4f; border-radius:8px; font-weight:bold; cursor:pointer; font-size:0.85rem; transition: background 0.2s;">
                    ã“ã®ç›®æ¨™ã‚’å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        `;
    }

    function jumpToTask(id) {
        // 1. è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.getElementById('detail-overlay').style.display = 'none';

        // 2. ã‚¿ã‚¹ã‚¯ã‚¿ãƒ–ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å…ˆã«ã€Œç›®æ¨™åˆ¥(goal)ã€ã«æ›¸ãæ›ãˆã‚‹
        const sortSelect = document.getElementById('task-sort-mode');
        if (sortSelect) {
            sortSelect.value = 'goal';
        }

        // 3. ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        // â€»showPage('tasks') ã®ä¸­ã§ renderTasks() ãŒå‘¼ã°ã‚Œã‚‹ã®ã§ã€
        // ã™ã§ã«ä¸Šã®æ‰‹é †2ã§æ›¸ãæ›ãˆãŸ 'goal' ãƒ¢ãƒ¼ãƒ‰ã§æç”»ã•ã‚Œã¾ã™
        showPage('tasks');

        // 4. è¦ç´ ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
            const el = document.getElementById('task-card-' + id) || document.getElementById('subtask-' + id);
            if(el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('highlight');
                setTimeout(() => el.classList.remove('highlight'), 2000);
            } else {
                console.log("Task not found: " + id);
            }
        }, 400); 
    }

    function renderTasks() {
        const container = document.getElementById('list-tasks');
        const sortMode = document.getElementById('task-sort-mode').value;
        const searchText = document.getElementById('task-search').value.toLowerCase();
        const onlyIncomplete = document.getElementById('task-filter-incomplete').checked;
        if (!container) return;
        container.innerHTML = "";

        // æ±äº¬æ™‚é–“ã®ä»Šæ—¥ã®æ—¥ä»˜
        const today = new Date().toLocaleString("sv-SE", {timeZone: "Asia/Tokyo"}).split(' ')[0];
        const priorityMap = { "é«˜": 1, "ä¸­": 2, "ä½": 3 };

        // 1. ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç† (t[3]ãŒã‚¿ã‚¹ã‚¯å)
        let allTasks = db.Tasks.slice(1).filter(t => {
            const taskName = String(t[3] || ""); // ã“ã“ã§å¼·åˆ¶çš„ã«æ–‡å­—åˆ—åŒ–
            return taskName.toLowerCase().includes(searchText);
        });
        if (onlyIncomplete) {
            allTasks = allTasks.filter(t => t[5] !== 'å®Œäº†'); // t[5]ãŒStatus
        }

        // 2. ã‚½ãƒ¼ãƒˆå‡¦ç† (t[6]ãŒDate, t[4]ãŒPriority)
        allTasks.sort((a, b) => {
            const dateA = (String(a[6] || "9999-12-31")).replace(/'/g, "");
            const dateB = (String(b[6] || "9999-12-31")).replace(/'/g, "");
            if (dateA !== dateB) return dateA.localeCompare(dateB);
            return (priorityMap[a[4]] || 4) - (priorityMap[b[4]] || 4);
        });

        // 3. è¡¨ç¤ºå¯¾è±¡ï¼ˆè¦ªã‚¿ã‚¹ã‚¯ã®ã¿ã‹å…¨ä»¶ã‹ / t[1]ãŒParent_IDï¼‰
        let displayTasks = (sortMode === 'parent') ? allTasks.filter(t => !t[1] || t[1] === "") : allTasks;

        // 4. ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        let groups = {};
        displayTasks.forEach(t => {
            let label = "æœŸé™ãªã—";
            if (sortMode === 'date') {
                const date = t[6] ? String(t[6]).replace(/'/g, "") : "æœŸé™ãªã—";
                if (date !== "æœŸé™ãªã—" && date < today && t[5] !== 'å®Œäº†') {
                    label = "âš ï¸ æœŸé™åˆ‡ã‚Œ";
                } else if (date === today) {
                    label = "ğŸ“Œ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯";
                } else {
                    label = date; 
                }
            } else if (sortMode === 'priority') {
                label = t[4] || "ãªã—";
            } else if (sortMode === 'goal') {
                // t[2]ãŒGoal_ID
                const goal = db.Goals.find(g => String(g[0]) === String(t[2]));
                label = goal ? "ç›®æ¨™: " + goal[2] : "æœªç´ä»˜ã‘";
            } else {
                label = ""; 
            }

            if (!groups[label]) groups[label] = [];
            groups[label].push(t);
        });

        // 5. ã‚°ãƒ«ãƒ¼ãƒ—æç”»
        const sortedKeys = Object.keys(groups).sort((a, b) => {
            if (sortMode === 'date') {
                if (a === "âš ï¸ æœŸé™åˆ‡ã‚Œ") return -1;
                if (b === "âš ï¸ æœŸé™åˆ‡ã‚Œ") return 1;
                if (a === "ğŸ“Œ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯") return -1;
                if (b === "ğŸ“Œ ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯") return 1;
                if (a === "æœŸé™ãªã—") return 1;
                return a.localeCompare(b);
            }
            return a.localeCompare(b);
        });

        sortedKeys.forEach(key => {
            if (key !== "") {
                const header = document.createElement('h3');
                header.style.cssText = "font-size:0.9rem; margin:20px 0 10px 5px; color:#666; border-left:4px solid #ccc; padding-left:10px;";
                header.innerText = key;
                container.appendChild(header);
            }

            groups[key].forEach(t => {
                const isDone = t[5] === 'å®Œäº†';
                const card = document.createElement('div');
                card.className = "card " + (isDone ? 'task-text-done' : '');
                card.id = 'task-card-' + t[0];
                
                // t[4]å„ªå…ˆåº¦, t[6]æœŸé™, t[3]ã‚¿ã‚¹ã‚¯å
                let html = `
                    <div style="font-size:0.7rem; display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>å„ªå…ˆåº¦: ${t[4] || '-'} æœŸé™: ${(t[6] || '').replace(/'/g, "") || 'ãªã—'}</span>
                        <span onclick="deleteItem(event, 'Tasks', '${t[0]}')" style="color:#ccc; cursor:pointer;">âœ• å‰Šé™¤</span>
                    </div>
                    <div class="task-row" style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleStatus('${t[0]}', this.checked)">
                        <span style="font-weight:bold; white-space:pre-wrap; word-break:break-all; ${isDone ? 'text-decoration:line-through;' : ''}">${t[3]}</span>
                    </div>`;
                
                // å­ã‚¿ã‚¹ã‚¯è¡¨ç¤º
                if (sortMode === 'parent') {
                    const childTasks = db.Tasks.filter(ct => String(ct[1]) === String(t[0]));
                    if (childTasks.length > 0) {
                        const doneSub = childTasks.filter(ct => ct[5] === 'å®Œäº†').length;
                        const prog = Math.round((doneSub / childTasks.length) * 100);
                        html += `<div style="height:4px; background:#eee; border-radius:2px; margin:8px 0;"><div style="width:${prog}%; height:100%; background:var(--primary-color); border-radius:2px;"></div></div>`;
                        
                        childTasks.forEach(ct => {
                            const isCtDone = ct[5] === 'å®Œäº†';
                            html += `
                                <div class="task-row" style="margin-left:20px; border:none; font-size:0.85rem; display:flex; align-items:center; gap:8px;">
                                    <input type="checkbox" ${isCtDone ? 'checked' : ''} onchange="toggleStatus('${ct[0]}', this.checked)">
                                    <span style="white-space:pre-wrap; word-break:break-all; ${isCtDone ? 'text-decoration:line-through; color:#ccc;' : ''}">${ct[3]}</span>
                                </div>`;
                        });
                    }
                }
                card.innerHTML = html;
                container.appendChild(card);
            });
        });
    }

    let currentLogCategory = 'ã™ã¹ã¦';

    function switchLogTab(cat, el) {
        currentLogCategory = cat;
        document.querySelectorAll('.log-tab-item').forEach(i => {
            i.classList.remove('active');
            i.style.background = 'transparent';
            i.style.color = '#888';
        });
        el.classList.add('active');
        el.style.background = '#fff';
        el.style.color = 'var(--primary-color)';
        renderLogs();
    }

    let isRootOnlyMode = false; // è¦ªè¨˜éŒ²ã®ã¿è¡¨ç¤ºã™ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°

    function toggleRootFilter() {
        isRootOnlyMode = !isRootOnlyMode;
        const btn = document.getElementById('root-filter-btn');
        const icon = document.getElementById('root-filter-icon');
        
        if (isRootOnlyMode) {
            btn.style.background = "var(--primary-color)";
            btn.style.color = "white";
            btn.style.borderColor = "var(--primary-color)";
            icon.innerText = "ğŸ¯";
        } else {
            btn.style.background = "#f0f2f5";
            btn.style.color = "#333";
            btn.style.borderColor = "#ddd";
            icon.innerText = "ğŸ”˜";
        }
        renderLogs();
    }
    
    function renderLogs(forcedSearchWord) {
        const container = document.getElementById('list-logs');
        if (!container) return;
        container.innerHTML = "";
        
        const allLogs = db.Logs.slice(1);
        
        // --- ã€ä¿®æ­£ï¼šæ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã®å–å¾—ã€‘ ---
        let searchWord = (forcedSearchWord !== undefined) 
            ? forcedSearchWord 
            : (document.getElementById('search-input')?.value || "");
        searchWord = searchWord.toLowerCase().trim();
        
        const seenTitles = new Set();
        
        // --- ã€ä¿®æ­£ï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã€‘ ---
        let displayLogs = allLogs.filter(l => {
            const title = l[5] ? String(l[5]).trim() : "";
            const content = l[3] ? String(l[3]).trim() : "";
            const english = l[4] ? String(l[4]).trim() : "";
            const category = l[1];
            const parentId = l[6] ? String(l[6]).trim() : "";

            // A. ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿
            const matchCat = (currentLogCategory === 'ã™ã¹ã¦' || category === currentLogCategory);
            if (!matchCat) return false;

            // B. æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰åˆ¤å®šï¼ˆé¡Œåãƒ»æœ¬æ–‡ãƒ»è‹±èªæ—¥è¨˜ã‚’å¯¾è±¡ï¼‰
            const matchSearch = searchWord === "" || 
                                title.toLowerCase().includes(searchWord) || 
                                content.toLowerCase().includes(searchWord) || 
                                english.toLowerCase().includes(searchWord);
            if (!matchSearch) return false;

            // C. ã€è¿½åŠ ã€‘è¦ªè¨˜éŒ²ã®ã¿çµã‚Šè¾¼ã¿ï¼ˆãƒœã‚¿ãƒ³ãŒONã®æ™‚ã€Parent_IDãŒã‚ã‚‹ã‚‚ã®ã‚’é™¤å¤–ï¼‰
            // â€»isRootOnlyMode å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æ
            if (typeof isRootOnlyMode !== 'undefined' && isRootOnlyMode && parentId !== "" && parentId !== "ãªã—") {
                return false;
            }

            // D. ã‚¿ã‚¤ãƒˆãƒ«é‡è¤‡æ’é™¤
            if (title === "") return true;
            if (seenTitles.has(title)) {
                return false;
            } else {
                seenTitles.add(title);
                return true;
            }
        });

        // ã‚½ãƒ¼ãƒˆ
        displayLogs.sort((a, b) => new Date(b[0]) - new Date(a[0]));

        // 2. ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆï¼ˆãƒãƒƒã‚¸æ©Ÿèƒ½ã€è¿”ä¿¡æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚‚å‰Šã‚‰ãšç¶­æŒï¼‰
        displayLogs.forEach(l => {
            const currentId = String(l[2]).trim();
            const currentTitle = String(l[5] || "").trim();
            const parentId = String(l[6] || "").trim();

            let connectionBadge = "";
            if (parentId && parentId !== "" && parentId !== "ãªã—") {
                const parentLog = allLogs.find(pl => String(pl[2]).trim() === parentId);
                if (parentLog && String(parentLog[5]).trim() !== currentTitle) {
                    connectionBadge = `<span style="background:#fff1f0; color:#cf1322; border:1px solid #ffa39e; padding:2px 6px; border-radius:4px; font-size:0.65rem; margin-right:5px;">ğŸ”— é–¢é€£ã‚ã‚Š</span>`;
                }
            } else {
                const hasLinkedChild = allLogs.some(cl => String(cl[6]).trim() === currentId && String(cl[5]).trim() !== currentTitle);
                if (hasLinkedChild) {
                    connectionBadge = `<span style="background:#f6ffed; color:#389e0d; border:1px solid #b7eb8f; padding:2px 6px; border-radius:4px; font-size:0.65rem; margin-right:5px;">ğŸ”— è¦ªãƒˆãƒ”ãƒƒã‚¯</span>`;
                }
            }

            let replyCount = 0;
            if (currentTitle !== "") {
                replyCount = allLogs.filter(cl => {
                    const isSelf = String(cl[2]).trim() === currentId;
                    const hasSameTitle = cl[5] && String(cl[5]).trim() === currentTitle;
                    return !isSelf && hasSameTitle;
                }).length;
            } else {
                replyCount = allLogs.filter(cl => String(cl[6]).trim() === currentId).length;
            }

            const mainText = (l[4] && String(l[4]).trim() !== "") ? l[4] : l[3];

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div onclick="showLogDetail('${l[2]}')">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:5px;">
                        <span style="font-size:0.75rem; color:var(--primary-color); font-weight:bold;">${formatDate(l[0])} [${l[1]}]</span>
                        <div style="display:flex; align-items:center;">
                            ${connectionBadge}
                            <span onclick="event.stopPropagation(); deleteItem(event, 'Daily_Logs', '${l[2]}')" style="color:#ccc; cursor:pointer; font-size:0.8rem; padding: 0 5px;">âœ•</span>
                        </div>
                    </div>
                    <div style="font-weight:bold; margin-bottom:5px; color:#333;">${l[5] || 'ç„¡é¡Œã®è¨˜éŒ²'}</div>
                    <div style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-size:0.95rem; color:#666; line-height:1.5;">
                        ${mainText}
                    </div>
                    ${replyCount > 0 ? `<div style="text-align:right; margin-top:8px; font-size:0.75rem; color:var(--primary-color); font-weight:bold; border-top: 1px dashed #eee; padding-top: 5px;">ğŸ’¬ ${replyCount}ä»¶ã®è¿”ä¿¡</div>` : ''}
                </div>
            `;
            container.appendChild(card);
        });
    }

    function showLogDetail(id) {
        const allLogs = db.Logs.slice(1);
        const log = allLogs.find(l => String(l[2]) === String(id));
        if (!log) return;

        const overlay = document.getElementById('detail-overlay');
        const titleEl = document.getElementById('detail-title');
        const bodyEl = document.getElementById('detail-dynamic-body');
        
        const currentTitle = log[5] ? String(log[5]).trim() : "";
        const parentId = log[6] ? String(log[6]).trim() : ""; // Gåˆ—ï¼šParent_ID

        overlay.style.display = 'flex';
        titleEl.innerText = currentTitle || "ç„¡é¡Œã®è¨˜éŒ²"; 

        // --- 1. åŒæ–¹å‘ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®ç”Ÿæˆï¼ˆã“ã“ãŒå‰Šã‚‰ã‚Œã¦ã„ã¾ã—ãŸï¼ï¼‰ ---
        let jumpLinkHtml = "";
        
        // A. è‡ªåˆ†ãŒã€Œå­ã€ã®å ´åˆï¼ˆParent_IDãŒã‚ã‚‹ï¼‰ã€è¦ªã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        if (parentId && parentId !== "" && parentId !== "ãªã—") {
            const parentLog = allLogs.find(pl => String(pl[2]).trim() === parentId);
            // ã‚¿ã‚¤ãƒˆãƒ«ãŒä¸€è‡´ã—ãªã„å ´åˆã®ã¿ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºï¼ˆä¸€è‡´ã™ã‚‹å ´åˆã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ï¼‰
            if (parentLog && String(parentLog[5]).trim() !== currentTitle) {
                jumpLinkHtml = `
                    <div onclick="showLogDetail('${parentId}')" style="margin-bottom:15px; padding:10px; background:#fff1f0; border:1px solid #ffa39e; border-radius:8px; color:#cf1322; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ”—</span> è¦ªãƒˆãƒ”ãƒƒã‚¯ã¸ç§»å‹•: <strong>${parentLog[5] || "ç„¡é¡Œ"}</strong>
                    </div>
                `;
            }
        } 
        // B. è‡ªåˆ†ãŒã€Œè¦ªã€ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ãŒä¸€è‡´ã—ãªã„ã€Œå­ã€ãŒä»–ã«ã„ã‚‹å ´åˆï¼ˆIDã§ç´ã¥ã„ã¦ã„ã‚‹å ´åˆï¼‰
        else {
            const linkedChild = allLogs.find(cl => String(cl[6]).trim() === String(id).trim() && String(cl[5]).trim() !== currentTitle);
            if (linkedChild) {
                jumpLinkHtml = `
                    <div onclick="showLogDetail('${linkedChild[2]}')" style="margin-bottom:15px; padding:10px; background:#f6ffed; border:1px solid #b7eb8f; border-radius:8px; color:#389e0d; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ”—</span> é–¢é€£ã™ã‚‹å­è¨˜éŒ²ã¸ç§»å‹•: <strong>${linkedChild[5] || 'ç„¡é¡Œ'}</strong>
                    </div>
                `;
            }
        }

        // --- 2. è‹±èªæ—¥è¨˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ ---
        let englishDiaryHtml = "";
        if (log[4] && String(log[4]).trim() !== "") {
            englishDiaryHtml = `
                <div style="margin-top:-10px; margin-bottom:20px; padding:15px; background:#f0f7ff; border-radius:10px; border:1px solid #d0e3ff; color:#2c3e50;">
                    <div style="font-size:0.75rem; font-weight:bold; color:#1a73e8; margin-bottom:5px; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ‡ºğŸ‡¸</span> English Diary
                    </div>
                    <div style="font-size:0.95rem; line-height:1.6; white-space:pre-wrap; font-family: 'Georgia', serif;">${log[4]}</div>
                </div>
            `;
        }

        // --- 3. ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºç”¨ã®æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸€è‡´ï¼‰ ---
        const children = allLogs.filter(cl => {
            const isSelf = String(cl[2]).trim() === String(id).trim();
            const hasSameTitle = currentTitle !== "" && cl[5] && String(cl[5]).trim() === currentTitle;
            return !isSelf && hasSameTitle;
        });
        
        let childrenHtml = children.map(cl => `
            <div id="log-child-${cl[2]}" style="background:#f4f4f4; margin-top:10px; padding:12px; border-radius:8px; border-left:4px solid #ccc; margin-left:15px;">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#999; margin-bottom:5px;">
                    <span>â”” ${formatDate(cl[0])}</span>
                    <span onclick="deleteItem(event, 'Daily_Logs', '${cl[2]}')" style="color:#ff4d4f; cursor:pointer;">å‰Šé™¤</span>
                </div>
                <div style="font-size:0.9rem; white-space:pre-wrap;">${cl[3]}</div>
            </div>
        `).join('');

        // --- 4. HTMLçµ„ã¿ç«‹ã¦ ---
        bodyEl.innerHTML = `
            ${jumpLinkHtml}
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">${formatDate(log[0])} [${log[1]}]</div>
            
            <div style="font-size:1rem; line-height:1.6; white-space:pre-wrap; margin-bottom:20px; padding:15px; background:#fdfdfd; border-radius:10px; border:1px solid #eee; color:#333;">${log[3]}</div>
            
            ${englishDiaryHtml}
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="copyThreadForGemini('${log[2]}')" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:0.85rem; display:flex; align-items:center; justify-content:center; gap:5px;">
                    <span>âœ¨</span> Geminiã«é€ã‚‹
                </button>
                <button onclick="replyToLog('${log[2]}', '${log[5]}', '${log[1]}')" style="flex:1; padding:12px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:0.85rem;">
                    ğŸ’¬ è¿”ä¿¡ã™ã‚‹
                </button>
            </div>
            
            <div style="font-weight:bold; font-size:0.9rem; color:var(--primary-color); border-top:1px solid #eee; padding-top:15px;">ğŸ’¬ ã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ã®å±¥æ­´ (${children.length})</div>
            <div id="log-thread-area">${childrenHtml || "<p style='color:#ccc; font-size:0.8rem; text-align:center; padding:20px;'>è¿”ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>"}</div>
        `;
    }
    
    function replyToLog(parentId, parentTitle, category) {
        document.getElementById('detail-overlay').style.display = 'none';
        currentPage = 'logs';
        openForm();
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«è¦ªã®æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
        document.getElementById('f1').value = category; 
        document.getElementById('f_log_title').value = parentTitle; 
        document.getElementById('f_log_parent').value = parentId; 
        
        document.getElementById('f2').placeholder = "ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ã®è¿”ä¿¡ã‚’å…¥åŠ›...";
        document.getElementById('f2').focus();
    }

    function replyToLog(parentId, parentTitle, category) {
        // è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        document.getElementById('detail-overlay').style.display = 'none';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
        currentPage = 'logs';
        openForm();
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‚’è¿”ä¿¡ç”¨ã«æ›¸ãæ›ãˆã‚‹
        document.getElementById('f1').value = category; // ã‚«ãƒ†ã‚´ãƒªã‚’è¦ªã«åˆã‚ã›ã‚‹
        document.getElementById('f_log_title').value = parentTitle; // é¡Œåã‚’è¦ªã«åˆã‚ã›ã‚‹
        document.getElementById('f_log_parent').value = parentId; // è¦ªIDã‚’ã‚»ãƒƒãƒˆ
        
        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’åˆ†ã‹ã‚Šã‚„ã™ãå¤‰æ›´
        document.getElementById('form-title').innerText = `ã€Œ${parentTitle}ã€ã¸è¿”ä¿¡`;
    }

    function deleteChildLog(event, id) {
        event.stopPropagation();
        if (!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const row = document.getElementById('child-row-' + id);
        if (row) row.style.opacity = "0.3";

        fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: "delete", sheetName: "Daily_Logs", id: id })
        }).then(() => {
            const idx = db.Logs.findIndex(l => l[2] === id);
            if (idx !== -1) db.Logs.splice(idx, 1);
            if (row) row.remove(); // ãã®è¡Œã ã‘ã‚’æ¶ˆã™
        });
    }

    function toggleChildren(id) {
        const area = document.getElementById('child-area-' + id);
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }

    function openForm() {
        const content = document.getElementById('form-content');
        document.getElementById('form-overlay').style.display = 'flex';
        document.getElementById('form-title').innerText = currentPage === 'goals' ? 'ç›®æ¨™ã®è¿½åŠ ' : (currentPage === 'tasks' ? 'ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ' : 'è¨˜éŒ²ã®è¿½åŠ ');

        if (currentPage === 'goals') {
            content.innerHTML = `
                <label>ã‚¿ã‚¤ãƒ—</label>
                <select id="f1" onchange="updateGoalDateInput(this.value)">
                    <option value="å¹´é–“">å¹´é–“</option>
                    <option value="æœˆé–“" selected>æœˆé–“</option>
                    <option value="é€±é–“">é€±é–“</option>
                </select>
                <label>æœŸé™æ—¥/å¯¾è±¡</label>
                <div id="goal-date-container"><input type="month" id="f_date"></div>
                <label>ç›®æ¨™å</label><input type="text" id="f2">
                <label>è©³ç´°/ç†ç”±</label><textarea id="f3" rows="3"></textarea>`;
        } else if (currentPage === 'tasks') {
            let gOpts = db.Goals.slice(1).map(g => `<option value="${g[0]}">${g[2]}</option>`).join('');
            let pOpts = db.Tasks.slice(1).filter(t => !t[1]).map(t => `<option value="${t[0]}">${t[3]}</option>`).join('');
            content.innerHTML = `<label>ã‚¿ã‚¹ã‚¯å</label><input type="text" id="f1"><label>æœŸé™æ—¥</label><input type="date" id="f_task_date"><label>å„ªå…ˆåº¦</label><select id="f_pri"><option>é«˜</option><option selected>ä¸­</option><option>ä½</option></select><label>ç›®æ¨™</label><select id="f2"><option value="">ãªã—</option>${gOpts}</select><label>è¦ªã‚¿ã‚¹ã‚¯</label><select id="f3"><option value="">ãªã—</option>${pOpts}</select>`;
        } else if (currentPage === 'logs') {
            // å…¨ãƒ­ã‚°ã‹ã‚‰ã€Œé‡è¤‡ã—ãªã„ã‚¿ã‚¤ãƒˆãƒ«ã€ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const uniqueTitles = new Set();
            const parentOpts = db.Logs.slice(1)
                .filter(l => {
                    const title = l[5]; // Fåˆ—: é¡Œå
                    if (!title || String(title).trim() === "") return false;
                    
                    // ã™ã§ã«åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ãŒSetã«ã‚ã‚‹å ´åˆã¯é™¤å¤–ï¼ˆï¼æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã ã‘æ¡ç”¨ï¼‰
                    if (uniqueTitles.has(title)) {
                        return false;
                    } else {
                        uniqueTitles.add(title);
                        return true;
                    }
                })
                .map(l => `<option value="${l[2]}">${l[5]}</option>`) // l[2]ã¯ID
                .join('');

            content.innerHTML = `
                <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                <select id="f1" onchange="document.getElementById('eng-field').style.display=this.value==='è‹±èªæ—¥è¨˜'?'block':'none'">
                    <option>æ€è€ƒã®å£æ‰“ã¡</option><option>èª­æ›¸è¨˜éŒ²</option><option>è‹±èªæ—¥è¨˜</option>
                </select>
                <label>é¡Œåï¼ˆæ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ç”¨ï¼‰</label>
                <input type="text" id="f_log_title" placeholder="æ–°ã—ã„ãƒˆãƒ”ãƒƒã‚¯å">
                <label>æ—¢å­˜ã®ãƒˆãƒ”ãƒƒã‚¯ã«ç´ã¥ã‘ã‚‹ï¼ˆä»»æ„ï¼‰</label>
                <select id="f_log_parent"><option value="">æ–°è¦ä½œæˆ</option>${parentOpts}</select>
                <label>å†…å®¹</label>
                <textarea id="f2" rows="4"></textarea>
                <div id="eng-field" style="display:none;"><label>English Diary</label><textarea id="f3" rows="4"></textarea></div>
            `;
        }
    }

    // é€±é–“ãŒé¸ã°ã‚ŒãŸæ™‚ã« ID="f_date_m" ã¨ "f_date_w" ã‚’ä½œã‚‹
    function updateGoalDateInput(type) {
        const container = document.getElementById('goal-date-container');
        if (type === 'å¹´é–“') {
            container.innerHTML = '<input type="number" id="f_date" value="2026" min="2025" max="2100" style="width:100%; padding:10px; box-sizing:border-box;">';
        } else if (type === 'é€±é–“') {
            container.innerHTML = `
                <div style="display:flex; gap:5px;">
                    <input type="month" id="f_date_m" style="flex:2; padding:10px; box-sizing:border-box;">
                    <select id="f_date_w" style="flex:1; padding:10px; box-sizing:border-box;">
                        <option value="1">1é€±ç›®</option><option value="2">2é€±ç›®</option>
                        <option value="3">3é€±ç›®</option><option value="4">4é€±ç›®</option><option value="5">5é€±ç›®</option>
                    </select>
                </div>`;
        } else {
            container.innerHTML = '<input type="month" id="f_date" style="width:100%; padding:10px; box-sizing:border-box;">';
        }
    }

    // é€±é–“ç›®æ¨™ãŒé¸ã°ã‚ŒãŸæ™‚ã«ã€Œé€±ã€ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
    function updateGoalDateInput(type) {
        const container = document.getElementById('goal-date-container');
        if (type === 'å¹´é–“') {
            container.innerHTML = '<input type="number" id="f_date" value="2026" min="2025" max="2100">';
        } else if (type === 'é€±é–“') {
            container.innerHTML = `
                <div style="display:flex; gap:5px;">
                    <input type="month" id="f_date_m" style="flex:2;">
                    <select id="f_date_w" style="flex:1;">
                        <option value="1">1é€±ç›®</option><option value="2">2é€±ç›®</option>
                        <option value="3">3é€±ç›®</option><option value="4">4é€±ç›®</option><option value="5">5é€±ç›®</option>
                    </select>
                </div>`;
        } else {
            container.innerHTML = '<input type="month" id="f_date">';
        }
    }

    // ç›®æ¨™ã®ã‚¿ã‚¤ãƒ—ã«åˆã‚ã›ã¦å…¥åŠ›æ¬„ã‚’å¤‰ãˆã‚‹è£œåŠ©é–¢æ•°
    function updateGoalDateInput(type) {
        const container = document.getElementById('goal-date-container');
        if (type === 'å¹´é–“') {
            container.innerHTML = '<input type="number" id="f_date" value="2026" min="2025" max="2100" style="width:100%; padding:10px;">';
        } else if (type === 'é€±é–“') {
            // æœˆã¨é€±ã‚’åˆ†ã‘ã¦å…¥åŠ›
            container.innerHTML = `
                <div style="display:flex; gap:5px;">
                    <input type="month" id="f_date_m" style="flex:2; padding:10px;">
                    <select id="f_date_w" style="flex:1; padding:10px;">
                        <option value="1é€±ç›®">1é€±ç›®</option><option value="2é€±ç›®">2é€±ç›®</option>
                        <option value="3é€±ç›®">3é€±ç›®</option><option value="4é€±ç›®">4é€±ç›®</option><option value="5é€±ç›®">5é€±ç›®</option>
                    </select>
                </div>`;
        } else {
            container.innerHTML = '<input type="month" id="f_date" style="width:100%; padding:10px;">';
        }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ç”¨
    async function updateGoalStatus(id, newStatus) {
        const card = document.getElementById('goal-card-' + id);
        if (card) card.style.opacity = "0.5";

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å³æ™‚åæ˜ 
        const goal = db.Goals.find(x => x[0] === id);
        if (goal) {
            goal[4] = newStatus; 
            renderGoals(); // å®Œäº†ãªã‚‰å³åº§ã«ã‚°ãƒ¬ãƒ¼ã«ã—ã¦ä¸‹ã«ç§»å‹•
        }

        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "updateStatus", 
                    sheetName: "Goals", 
                    id: id, 
                    status: newStatus 
                })
            });
            // é€šä¿¡å¾Œã€ä¸€å¿œæœ€æ–°çŠ¶æ…‹ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            refreshData();
        } catch (e) {
            console.error("æ›´æ–°å¤±æ•—:", e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            refreshData();
        }
    }

    async function submitForm() {
        const sheetName = currentPage === 'goals' ? 'Goals' : (currentPage === 'tasks' ? 'Tasks' : 'Daily_Logs');
        let data = [];
        const today = new Date().toLocaleString("sv-SE", {timeZone: "Asia/Tokyo"}).split(' ')[0];
        const tempId = (sheetName === 'Goals' ? 'G-' : sheetName === 'Tasks' ? 'T-' : 'L-') + Date.now();

        try {
            // 1. å„ã‚«ãƒ†ã‚´ãƒªã®å…¥åŠ›å€¤å–å¾—ã¨ãƒ‡ãƒ¼ã‚¿æ•´å½¢
            if (currentPage === 'goals') {
                const type = document.getElementById('f1').value;
                const title = document.getElementById('f2').value;
                if (!title) throw new Error("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                const targetMonth = (type === 'é€±é–“') ? (document.getElementById('f_date_m').value + "-" + document.getElementById('f_date_w').value) : (document.getElementById('f_date')?.value || "");
                data = [tempId, type, title, document.getElementById('f3').value, "é€²è¡Œä¸­", "'" + targetMonth];

            } else if (currentPage === 'tasks') {
                const name = document.getElementById('f1').value;
                if (!name) throw new Error("ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                data = [tempId, document.getElementById('f3').value || "", document.getElementById('f2').value || "", name, document.getElementById('f_pri').value, "æœªå®Œäº†", "'" + document.getElementById('f_task_date').value];

            } else if (currentPage === 'logs') {
                const content = document.getElementById('f2').value;
                if (!content) throw new Error("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                data = [today, document.getElementById('f1').value, tempId, content, document.getElementById('f3').value || "", document.getElementById('f_log_title').value || "ç„¡é¡Œ", document.getElementById('f_log_parent').value || ""];
            }

            // --- ã“ã“ã‹ã‚‰ãŒã€Œå³æ™‚åæ˜ ã€ã®ã‚­ãƒ¢ ---
            
            // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(db)ã«å…ˆã«çªã£è¾¼ã‚€
            const dbKey = (sheetName === 'Daily_Logs' ? 'Logs' : sheetName);
            db[dbKey].push(data);

            // 3. ãƒ•ã‚©ãƒ¼ãƒ ã‚’å³åº§ã«é–‰ã˜ã¦ã€ã‚«ãƒ¼ãƒ‰ã‚’å†æç”»ã™ã‚‹
            document.getElementById('form-overlay').style.display = 'none';
            if (currentPage === 'goals') renderGoals();
            else if (currentPage === 'tasks') renderTasks();
            else renderLogs();

            // 4. ã€è£ã§å‡¦ç†ã€‘GASã«ã“ã£ãã‚Šé€ä¿¡ã™ã‚‹
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ action: "saveRecord", sheetName: sheetName, data: data })
            }).then(() => {
                console.log("Backend sync complete.");
                // ã‚µãƒ¼ãƒãƒ¼ã¨å®Œå…¨ã«åŒæœŸã•ã›ã‚‹ãŸã‚ã€ã—ã°ã‚‰ãã—ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆä»»æ„ï¼‰
                // refreshData(); 
            }).catch(err => {
                console.error("Backend sync failed:", err);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            });

        } catch (err) {
            alert(err.message);
        }
    }

    async function deleteItem(event, sheetName, id) {
        if (event && event.stopPropagation) event.stopPropagation();
        if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

        // --- 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿(db)ã‹ã‚‰å³åº§ã«å‰Šé™¤ ---
        const dbKey = (sheetName === 'Daily_Logs' || sheetName === 'Logs') ? 'Logs' : sheetName;
        let parentIdToUpdate = null;

        if (db[dbKey]) {
            // å‰Šé™¤å¯¾è±¡ãŒå­è¨˜éŒ²ã®å ´åˆã€ãã®è¦ªIDã‚’ç‰¹å®šã—ã¦ãŠãï¼ˆè¿”ä¿¡æ•°æ›´æ–°ã®ãŸã‚ï¼‰
            const targetItem = db[dbKey].find(item => String(item[2]) === String(id));
            if (targetItem && targetItem[6]) {
                parentIdToUpdate = targetItem[6]; // Parent_IDã‚’å–å¾—
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å‰Šé™¤
            db[dbKey] = db[dbKey].filter(item => String(item[2]) !== String(id) && String(item[0]) !== String(id));
        }

        // --- 2. ç”»é¢ä¸Šã®è¦ç´ ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¶ˆã™ ---
        const targetCard = (event && event.target) ? event.target.closest('.card') || event.target.closest('[id^="log-child-"]') : null;
        if (targetCard) {
            targetCard.style.transition = "opacity 0.2s";
            targetCard.style.opacity = "0";
            setTimeout(() => targetCard.style.display = "none", 200);
        }

        // --- 3. UIã®å†æç”»ï¼ˆã“ã“ãŒé‡è¦ã§ã™ï¼‰ ---
        if (sheetName === 'Daily_Logs' || sheetName === 'Logs') {
            // è©³ç´°ç”»é¢ã‚’é–‹ã„ã¦ã„ã‚‹å ´åˆã€ä¸­èº«ã‚’å†æç”»ã—ã¦å­è¨˜éŒ²ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            const detailOverlay = document.getElementById('log-detail-overlay');
            if (detailOverlay && detailOverlay.style.display === 'flex') {
                const currentId = document.getElementById('log-detail-parent-id')?.value;
                if (currentId) {
                    // è©³ç´°ç”»é¢å†…ã®ãƒªã‚¹ãƒˆã‚’æœ€æ–°ã® db.Logs ã«åŸºã¥ã„ã¦ä½œã‚Šç›´ã™
                    showLogDetail(currentId); 
                }
            }
            // ä¸€è¦§ç”»é¢ã®ã€Œã€‡ä»¶ã®è¿”ä¿¡ã€ã¨ã„ã†æ–‡å­—ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å†æç”»
            renderLogs();
        } else if (sheetName === 'Goals') {
            renderGoals();
        } else {
            renderTasks();
        }

        // --- 4. GASã¸é€ä¿¡ï¼ˆè£å´ã§å®Ÿè¡Œï¼‰ ---
        fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ 
                action: "delete", 
                sheetName: (sheetName === 'Logs' ? 'Daily_Logs' : sheetName), 
                id: id 
            })
        });
    }

    async function toggleStatus(id, isChecked) {
        const newStatus = isChecked ? 'å®Œäº†' : 'æœªå®Œäº†';
        
        // 1. ã€çˆ†é€ŸåŒ–ã€‘ç”»é¢ä¸Šã®è¦‹ãŸç›®ã‚’å³åº§ã«å¤‰ãˆã‚‹
        const targetEl = document.getElementById('task-card-' + id) || document.getElementById('subtask-' + id);
        if (targetEl) {
            if (isChecked) targetEl.classList.add('task-text-done');
            else targetEl.classList.remove('task-text-done');
            if (targetEl.id.startsWith('subtask-')) {
                targetEl.style.textDecoration = isChecked ? 'line-through' : 'none';
            }
        }

        // 2. ã€ã“ã“ãŒé‡è¦ï¼ã€‘æ‰‹å…ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (db.Tasks) ã‚’å³åº§ã«æ›´æ–°ã™ã‚‹
        if (db.Tasks) {
            // IDãŒä¸€è‡´ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æ¢ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹(ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5)ã‚’æ›¸ãæ›ãˆã‚‹
            const taskIndex = db.Tasks.findIndex(t => String(t[0]) === String(id));
            if (taskIndex !== -1) {
                db.Tasks[taskIndex][5] = newStatus;
                console.log("Local db.Tasks updated:", id, newStatus);
            }
        }

        try {
            // 3. è£ã§GASã«ä¿å­˜é€šä¿¡
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "updateStatus", id: id, status: newStatus })
            });
        } catch (e) {
            console.error("ä¿å­˜å¤±æ•—:", e);
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
            refreshData(); // å¤±æ•—ã—ãŸæ™‚ã ã‘å…ƒã®è¡¨ç¤ºã«æˆ»ã™
        }
    }

    function copyThreadForGemini(parentId) {
        const allLogs = db.Logs.slice(1);
        const parent = allLogs.find(l => String(l[2]) === String(parentId));
        if (!parent) return;

        const children = allLogs.filter(cl => String(cl[6]) === String(parentId));
        const sortedChildren = children.sort((a, b) => new Date(a[0]) - new Date(b[0]));

        const category = String(parent[1] || "").trim(); 
        const content = parent[3];       // Dåˆ—: æœ¬æ–‡
        const englishDiary = parent[4];  // Eåˆ—: è‹±èªæ—¥è¨˜ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
        const title = parent[5] || 'ç„¡é¡Œ'; // Fåˆ—: é¡Œå

        let instruction = "";

        // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸæŒ‡ç¤ºå‡ºã—
        if (category.includes('æ€è€ƒ')) {
            instruction = "ç§ã®æ€è€ƒã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ•´ç†ã—ã€å®¢è¦³çš„ãªè¦–ç‚¹ã‹ã‚‰æ·±æ˜ã‚Šã™ã‚‹ãŸã‚ã®è³ªå•ã‚„ã€æ–°ã—ã„æ°—ã¥ãã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚";
        } else if (category.includes('èª­æ›¸')) {
            instruction = "ã“ã®æœ¬ã®è¦ç´„ã¨ç§ã®æ°—ã¥ãã‚’è¸ã¾ãˆã¦ã€ä»–ã®æœ¬ã¨ã®é–¢é€£æ€§ã‚„ã€å®Ÿç”Ÿæ´»ã§ã©ã†æ´»ã‹ã›ã‚‹ã‹ã®å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚";
        } else if (category.includes('è‹±èª')) {
            instruction = "ã“ã®è‹±èªæ—¥è¨˜ã®è¡¨ç¾ã«ä¸è‡ªç„¶ãªç‚¹ãŒã‚ã‚Œã°æ·»å‰Šã—ã€ã‚ˆã‚Šãƒã‚¤ãƒ†ã‚£ãƒ–ã«è¿‘ã„è¡¨ç¾ã‚„ã€é–¢é€£ã™ã‚‹ä¾¿åˆ©ãªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã„ãã¤ã‹æ•™ãˆã¦ãã ã•ã„ã€‚";
        } else {
            instruction = `ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼š${category}ï¼‰ã®å†…å®¹ã‚’è¸ã¾ãˆã¦ã€ã‚ãªãŸã¨ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦ãŠè©±ã—ã—ãŸã„ã§ã™ã€‚`;
        }

        // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦é–‹å§‹ ---
        let prompt = `ã“ã‚Œã¾ã§ã«ä»¥ä¸‹ã®æ§˜ãªè‡ªå·±å¯¾è©±ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼š${category}ï¼‰ã‚’ã—ã¦ãã¾ã—ãŸã€‚\n\n`;
        prompt += `â–  é¡Œå: ${title}\n`;
        prompt += `â–  é–‹å§‹æ—¥: ${formatDate(parent[0])}\n\n`;
        
        // è‹±èªæ—¥è¨˜ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã®ã¿ã€Eåˆ—ã®å†…å®¹ã‚’ã€Œè‹±èªæ—¥è¨˜ã€ã¨ã—ã¦è¿½åŠ 
        if (category.includes('è‹±èª') && englishDiary && String(englishDiary).trim() !== "") {
            prompt += `â–  æ—¥æœ¬èªæœ¬æ–‡:\n${content}\n\n`;
            prompt += `â–  è‹±èªæ—¥è¨˜:\n${englishDiary}\n\n`;
        } else {
            // ãã‚Œä»¥å¤–ã¯é€šå¸¸ã®ã€Œå†…å®¹ã€ã¨ã—ã¦è¡¨ç¤º
            prompt += `â–  å†…å®¹:\n${content}\n\n`;
        }

        // è¿½è¨˜ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
        if (sortedChildren.length > 0) {
            prompt += `--- è¿½è¨˜å±¥æ­´ ---\n`;
            sortedChildren.forEach(cl => {
                prompt += `[${formatDate(cl[0])}] ${cl[3]}\n`;
            });
            prompt += `---------------\n\n`;
        }

        prompt += `ã€Geminiã¸ã®ä¾é ¼ã€‘\n`;
        prompt += `${instruction}`;
        // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦çµ‚äº† ---

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        navigator.clipboard.writeText(prompt).then(() => {
            // Geminiã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã
            window.open('https://gemini.google.com/app', '_blank');
        }).catch(err => {
            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
        });
    }
    
</script>

    <div id="review-modal" class="overlay" style="display:none; z-index: 2000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="form-container" style="max-height: 80vh; overflow-y: auto; background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px;">
            <h3 style="margin-top:0;">æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 8px;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹æœˆã‚’é¸æŠï¼š</label>
                <input type="month" id="review-month-picker" onchange="updateReviewContent(this.value)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div id="review-modal-body"></div>

            <div style="display:flex; gap:10px; margin-top:25px; border-top: 1px solid #eee; padding-top: 20px;">
                <button onclick="document.getElementById('review-modal').style.display='none'" style="flex:1; padding:12px; background:#eee; border:none; border-radius:8px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="submit-review-btn" onclick="submitReview()" style="flex:1; padding:12px; background:var(--primary-color); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ»å‰Šé™¤</button>
            </div>
        </div>
    </div>

</body>
</html>
